<workunit>
    <invokers>
        <invoker type="cashreceipt:select-afcontrol" caption="Select Accountable Form" target="popup"/>
        <invoker type="cashreceipt-initial:formActions" caption="Select AF" target="popup" action="init"/>
        
        <!-- OWN TOOLBARS -->
        <invoker type="formActions" caption="Close" action="_close"/>
        <invoker type="formActions" caption="Activate" action="activate" xvisibleWhen="#{selectedItem!=null &amp;&amp; selectedItem.active==0}"/>
        <invoker type="formActions" caption="Assign" action="assign"  xvisibleWhen="#{selectedItem!=null &amp;&amp; selectedItem.active==0}"/>
        <invoker type="formActions" caption="Deactivate" action="deactivate" xvisibleWhen="#{selectedItem!=null &amp;&amp; selectedItem.active==1}"/>
        <invoker type="formActions" caption="View Assign To" action="_assignTo" />
        <invoker type="formActions" caption="Change Mode" action="changeMode" />
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.enterprise.treasury.cashreceipt.*
        
        class  SelectAFController  {
            
            @Service("AFSerialControlService")
            def svc;
            
            def handler;
            def selectedItem;
            def selectedAssignee;
            def entity;
            def list;
            
            String title = "Manage Accountable Forms";
            
            void init() {
                if(!entity.formno)
                    throw new Exception("Please select an accountable form first");
            }
            
            void activate() {
                if(selectedItem.active==1)
                    throw new Exception("Entry is already active");
                def z = [:];
                z.objid = selectedItem.objid;
                z.txnmode = selectedItem.txnmode;
                z.afid = entity.formno
                svc.activateControl(z);
                listModel.reload();    
            }
            
            void deactivate() {
                if(selectedItem.active==0)
                    throw new Exception("Entry is not active");
                svc.deactivateControl([objid: selectedItem.objid]);
                listModel.reload();
            }

            def assign() {
                if(selectedItem.active==1) {
                    throw new Exception("Entry is currently active. Deactivate first");
                }    
                return InvokerUtil.lookupOpener("subcollector:lookup", [
                    onselect:{x->
                        svc.assignToSubcollector( [objid:selectedItem.objid, assignee:x] );
                        listModel.reload();
                    }
                ] );    
            }

            def changeMode() {
                if(!selectedItem) throw new Exception("Select an item");
                return InvokerUtil.lookupOpener("afserial:changemode", 
                    [entity:selectedItem, saveHandler: { listModel.reload(); }] 
                );
            }
            
            def listModel = [
                fetchList: { o->
                    list = svc.getOpenIssuanceList( [af:entity.formno, txnmode:entity.txnmode] );
                    return list;
                },
                getContextMenu: { o,colName->
                    def list = [];
                    if(o.active==0) {
                        list.add( [value:'Activate',id:'activate'] );
                        list.add([value:'Assign',id:'assign']);    
                    }    
                    else{
                        list.add([value:'Deactivate',id:'deactivate']);                    
                    }
                    list.add([value:'Change Mode',id:'changemode']);
                    return list;
                },
                callContextMenu: { o,m->
                    if( m.id == "activate") activate();
                    else if(m.id == "deactivate") deactivate();
                    else if(m.id=="assign") {
                        return assign();
                    }    
                    else if(m.id=="changemode") {
                        return changeMode();
                    }    
                }
            ] as BasicListModel;
            
            
            def assigneeListModel = [
                fetchList: { o->
                    list = svc.getAssigneeIssuanceList( [af:entity.formno, txnmode:entity.txnmode] );
                    return list;
                },
                getContextMenu: { o,colName->
                    def list = [];
                    if(o.active==0) list.add( [value:'Activate',id:'activate'] );
                    if(o.active==1) list.add([value:'Deactivate',id:'deactivate']);                    
                    list.add([value:'Assign',id:'assign']);
                    return list;
                },
                callContextMenu: { o,m->
                    listModel.reload();
                }
            ] as BasicListModel;
            
            
            def doClose() {
                return "_close";
            }
        }
        ]]>
        
    </code>
    
    <pages>
        <page template="com.rameses.gov.treasury.cashreceipt.SelectAFPage"/>
        <page name="assignTo" template="com.rameses.gov.treasury.cashreceipt.AFAssignToPage"/>
    </pages>
    
</workunit>