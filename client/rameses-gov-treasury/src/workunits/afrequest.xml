<workunit>
    <invokers>
        <invoker type="afrequest:create" caption="AF Requisition" action="create" target="window"/>
        
        <invoker type="afrequest:formActions" 
            caption="New AF Request" action="create" target="window"/>
        
        
        <invoker folderid="/txn/treasury" action="create" caption="Request Accountable Form" target="window"/>

        <invoker type="node:afrequest:create" caption="AF Requisition" action="create" target="window"/>
        <invoker type="node:afrequest:open" caption="AF Requisition" action="open" target="window"/>
        
        <invoker type="formActions" action="start" caption="Next" visibleWhen="#{mode=='initial'}"/>
        <invoker type="formActions" action="submit" caption="Submit" visibleWhen="#{mode=='create'}"/>
        
        <invoker type="navActions" action="addItem" caption="Add Receipt" visibleWhen="#{mode=='create'}"/>
        
        <invoker type="formActions" action="_close" caption="Close" visibleWhen="#{!!(entity.state)}"/>
        <invoker type="formActions" action="approve" caption="Approve" visibleWhen="#{entity.state=='DRAFT'}"/>
        <invoker type="formActions" action="createReceipt" caption="Create Receipt" visibleWhen="#{entity.state=='APPROVED'}"/>

    </invokers>
    
    <code>
        <![CDATA[
        
            import com.rameses.rcp.annotations.*
            import com.rameses.rcp.common.*
            import com.rameses.osiris2.client.*
            import com.rameses.osiris2.common.*

            class AFRequestController {

                @Service("AFRequestService")
                def afrequestSvc;
                
                String title = "AF Request";
                
                def entity;
                def requestTypes;
                def requestType;
                
                def selectedItem;
                boolean showall = true;
                def mode = "create";
                
                def create() {
                   entity =  [items:[]];
                   mode = "initial";
                   requestTypes = InvokerUtil.lookupOpeners( "afrequest:type", [entity: entity ]);
                   return "initial";
                }
                
                def start() {
                    entity.txntype = requestType.caption; 
                    mode = "create";
                    return "info";
                }

                def reqItemModel = [
                    fetchList: {o->
                        entity.items;
                    }
                ] as BasicListModel;

                
                def addItem() {
                    return InvokerUtil.lookupOpener( "afrequest:additem", 
                        [  entity: entity,
                           saveHandler: { 
                              reqItemModel.reload();
                           }
                         ]
                     );
                }
                
                void submit() {
                    if(MsgBox.confirm("You are about to submit this request. Proceed?")) {
                        entity = afrequestSvc.create( entity );
                        this.mode = "read";
                    }
                }
                
                def open() {
                    entity = afrequestSvc.open(entity);
                    mode = "read";
                    return "info";
                }
                
                def approve() {
                    if(MsgBox.confirm("Approve this document?")) {
                        afrequestSvc.approve(entity);
                        entity.state = 'APPROVED';
                    }
                }
                def createReceipt() {
                   def opener = InvokerUtil.lookupOpener( "afreceipt:create", [request:entity] );
                   opener.target = null;
                   return opener;
                }
            }
            
     ]]>
    </code>
    
    <pages>
        <page name="initial" template="com.rameses.gov.treasury.af.AFRequestInitialPage"/>
        <page name="info" template="com.rameses.gov.treasury.af.AFRequestPage"/>
    </pages>
</workunit>