<workunit>

    <invokers>
        <invoker folderid="/menu/txn/bpls" caption="New Application" 
            action="start" target="window" index="0"/>       
            
        <invoker folderid="/explorer/txn/bpls" caption="New Application" 
            action="start" target="window" index="0"/>        
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import etracs2.bpls.application.*;
        import java.rmi.server.*;
        
        class NewBusinessApplicationController extends AbstractBplsApplication {
        
            /** Listings **/
            @Service("NewBPLApplicationService")
            def svc;
            
            @Service("BPLAssessmentService")
            def assessmentSvc;
            
            def start() {
                application = [objid: "BPL-"+new UID()];
                application.permitee = [:];
                application.lobs = [];
                application.infos = [];
                application.docstate = "DRAFT";
                application.txnmode = "ONLINE";
                application.txntype = "NEW";
                return super.start();
            }
            
            void runAssessment() {
                editableInfos.clear();
                def result = assessmentSvc.execute( application );
                if(result.infos) {
                    editableInfos.addAll( result.infos );
                }
            }
                
            
        }
        
        
        ]]>
    </code>
    
    <pageflow>
         <start>
            <transition to="new"/>
        </start>
        <page name="new" title="Basic Information">
            <transition to="end" caption="Close" />
            <transition to="add-lob" caption="Submit" immediate="false" />
        </page>
        <page name="add-lob" title="Add Line(s) of Business">
            <transition to="end" caption="Close" />
            <transition to="new" caption="Back"/>
            <transition to="assess" caption="Next"/>
        </page>

        <process name="assess" action="runAssessment">
            <transition to="add-info" cond="#{hasMoreInfo}"/>
            <transition to="view-assessment" cond="#{!hasMoreInfo}"/>
        </process>

        <page name="add-info" title="Specify Business Information">
            <transition to="end" caption="Close" />
            <transition to="add-lob" visibleWhen="#{maxLevel == 0 }" caption="Back" action="resetPreviousInfo"/>
            <transition to="add-info" caption="Step Back" visibleWhen="#{maxLevel &gt; 0 }" action="resetPreviousInfo"/>
            <transition to="assess" caption="Next" />
        </page>
        
        <page name="view-assessment" title="View Assessment">
            <transition to="add-info" caption="Back" action="resetInfos" />
            <transition to="for-approval" caption="Submit for Approval"/>
        </page>    
        
        <page name="for-approval" title="View Assessment">
            <transition to="end" caption="Close"/>
            <transition to="approve" caption="Approve"/>
        </page>    

        <end/>

    </pageflow>
    
    <pages>
        <page name="new" template="etracs2.bpls.application.NewApplicationPage" />
        <page name="add-lob" template="etracs2.bpls.application.SpecifyLobPage" />
        <page name="add-info" template="etracs2.bpls.application.SpecifyInfoPage" />
        <page name="view-assessment" template="etracs2.bpls.application.ViewAssessmentPage" />
        <page name="for-approval" template="etracs2.bpls.application.ViewAssessmentPage" />
    </pages>
    
</workunit>
