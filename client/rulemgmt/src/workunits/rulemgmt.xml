<workunit>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.rules.helpers.*;
        
        class RuleMgmtController {
        
            @Invoker
            def invoker;
        
            @Service("RuleSupportService")
            def ruleSupport;
            
            @Service("RuleMgmtService")
            def ruleMgmtSvc;
            
            def formActions = []    
            def selectedItem;
            def ruleset;
            def qry = [:];
            def agendaGroups;

            private def _ruleMgmt;

            void init() {
                ruleset = invoker.properties.ruleset;
                agendaGroups = ruleSupport.getAgendaGroups([ruleset: ruleset]);
            }
            
            private RuleMgmt getRuleMgmt() {
                if(_ruleMgmt==null) {
                    _ruleMgmt = new RuleMgmt( ruleset: ruleset );
                    def m = [ruleset: ruleset];
                    ruleMgmt.facts = ruleSupport.getFacts(m);
                    ruleMgmt.actions = ruleSupport.getActions(m);
                    ruleMgmt.agendaGroups = agendaGroups; 
                }
                return _ruleMgmt;
            }
            
            public def create() {
                return InvokerUtil.lookupOpener( "rule:create", [ruleMgmt: ruleMgmt ] );
            }
            
            public def open() {
                def rule = ruleMgmtSvc.open(selectedItem);
                return InvokerUtil.lookupOpener( "rule:open", [
                    ruleMgmtListHandler: listHandler, 
                    ruleMgmt: ruleMgmt, 
                    rule: rule                     
                ]);
            }
            
            def listHandler = [
                fetchList: { o->
                    o.ruleset = ruleset;
                    o.putAll(qry);
                    return ruleMgmtSvc.getList(o);
                }
            ] as PageListModel;
        
            public String getTitle() {
                return invoker.caption;
            }
            
            def getRuleStates() {
                return LOV.RULE_STATES;
            }
            
            def invoke(def inv) {
                if(!inv.properties.opener)
                    throw new Exception("Please specify an opener attribute in the invoker");
                return InvokerUtil.lookupOpener( inv.properties.opener );
            }
        }
        
        ]]>
        
    </code>
    
    <pages>
        <page template="com.rameses.rules.ui.RuleMgmtPage"/>
    </pages>
    
</workunit>