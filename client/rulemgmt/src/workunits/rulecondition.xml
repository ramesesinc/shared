<workunit>
    
    <invokers>
        <invoker type="rulecondition:edit" action="open" caption="Edit Rule Condition" target="popup" />
        <invoker type="rulecondition:create" action="create" caption="Create Rule Condition" target="popup"/>
    </invokers>
    
    <code>
        <![CDATA[    

        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.rules.helpers.*;
        
        class RuleConditionController {
        
            @Binding
            def binding;
        
            //caller-supplied variables
            def rule;
            def condition; 
            def factList;   
            def varList;
            def selectedFact;
            def saveHandler;

            def create() {
                condition = [constraints:[]];
                return "default";
            }
            
            def open() {
                if (!condition.constraints) condition.constraints = [];
                
                selectedFact = factList.find{ it.name == condition.name; };
                if (!selectedFact) 
                    throw new Exception("'"+condition.name+"' rule fact not found"); 
                    
                def opener = selectFact();
                opener.target = 'popup';
                return opener;
            }

            def selectFact() {  
                if(!selectedFact.factclass)
                    throw new Exception("There is no factclass specified. Please check the definition");
                condition.name = selectedFact.name;
                condition.factclass = selectedFact.factclass;
                def handler = "conditionhandler:basic";
                
                return InvokerUtil.lookupOpener( handler,
                    [ rule: rule, 
                      condition: condition, 
                      fact: selectedFact, 
                      varList: varList,
                      saveHandler: saveHandler
                    ] 
                );
            }

            
        }
        
        ]]>
    </code>
    
    <pages>
        <page name="default" template="com.rameses.rules.ui.SelectFactPage"/>
    </pages>
    
</workunit>