<workunit>
    <invokers>
        <invoker type="actionvaluehandler:expression" action="init"/>
    </invokers>
    <code>
        <![CDATA[    

        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.common.*;
        
        class ExpressionValueHandler 
        {        
            @Binding
            def binding;
            
            @Caller
            def caller;
            
            def actionParam;
            def vars;

            def exprtype;    
            
            def init() {
                exprtype = actionParam.exprtype;
                if(!exprtype)  
                    return "select";
                else 
                    return "default";
            }
            
            def getValueText() {
                if( exprtype == "formula") {
                    return actionParam.expr;
                }
                else {
                    def b = new StringBuilder();
                    b.append("<html><table>");
                    b.append("<tr><td colspan=3>Variable:"+ actionParam.var.name +  "</td></tr>");
                    b.append("<tr>");
                    b.append("<th>From</th><th>To</th><th>Value</th>");
                    b.append("</tr>");
                    actionParam.entries.each {
                        b.append("<tr>");
                        b.append("<td>"+it.from+"</td><td>"+it.to+"</td><td>"+it.value+"</td>");
                        b.append("</tr>");
                    }
                    return b.toString();
                }
            }
            
            def getFormulaHandler() {
                return InvokerUtil.lookupOpener("expression:editor", [
                    value:actionParam.expr, 
                    vars: vars,
                    handler: { o->
                        actionParam.expr = o;
                        actionParam.exprtype = exprtype;
                        caller.binding.refresh();
                    }
                ]);
             }

             def getTableHandler() {
                def vlist = vars.findAll{ it.datatype.matches("decimal|integer") };
                return InvokerUtil.lookupOpener("valuerange:editor", [
                    entries:actionParam.entries,
                    var:actionParam.var,
                    vars: vlist,
                    handler: { o->
                        actionParam.entries = o.entries;
                        actionParam.var = o.var;
                        actionParam.exprtype = exprtype;
                        caller.binding.refresh();    
                    }
                ]);    
             }

            def configure() {
                return edit();
            }
            
            def edit() {
                if(exprtype == "formula") {
                    return getFormulaHandler();
                }
                else {
                    return getTableHandler();
                }
            }
            
            def reset() {
                exprtype = null;
                actionParam.expression = null;
                actionParam.exprtype = null;
                actionParam.entries = [];
                return init();
            }
        }
        ]]>
        
    </code>
    
    <pages>
        <page name="default" template="com.rameses.rules.actions.ui.ExpressionValueHandler"/>
        <page name="select" template="com.rameses.rules.actions.ui.SelectExpressionHandler"/>
    </pages>
    
</workunit>