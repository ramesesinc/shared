<workunit>
    <invokers>
        <invoker type="conditionvaluehandler:object" action="init"/>
    </invokers>
    <code>
         <![CDATA[    

        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.rules.helpers.*;
        
        class ObjectConditionValueHandler {
        
            @Binding
            def binding;
        
            def constraint;
            def fieldDef;
            
            def handler;
            def multi;
            
            void init() {
                handler = fieldDef.handler;
                if(!handler) 
                    throw new Exception("Please specify a handler in the fact definition");  
                multi = (constraint.operator.multi == true)?true:false;                    
            }
            
            def viewValueOpener() {
                def params = [:];
                params.multiSelect = multi;
                def itemKey = fieldDef.itemKey;
                def itemValue = fieldDef.itemValue;
                if(multi == true ) {
                    params.multiSelectHandler = { o->
                        if(!constraint.value) return false;
                        return (constraint.value.find{ o[itemKey] == it.key }!=null);
                    };
                    params.onselect = { val->
                        def list = val.collect{ [key: it[itemKey], value:it[itemValue] ]};
                        constraint.valueText = list*.value.join(",");
                        constraint.value = '"' + list*.key.join("|") + '"';
                        binding.refresh();
                    } ; 
                }
                else {
                    params.onselect = { val-> 
                        constraint.valueText = val[itemValue]; 
                        constraint.value = val[itemKey]; 
                        binding.refresh(); 
                    }; 
                }
                return InvokerUtil.lookupOpener( handler, params );
            }
        }
        
        ]]>
        
    </code>
    
    <pages>
        <page name="default" template="com.rameses.rules.constraints.ui.ObjectHandler"/>
    </pages>
    
</workunit>