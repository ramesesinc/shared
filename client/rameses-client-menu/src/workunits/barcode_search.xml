<workunit>
    <invokers>
        <invoker type="toolbar" icon="images/toolbars/barcode.png" caption="" 
            action="init" target="popup" permission="system" windowmode="glasspane" 
            tooltip="Barcode Search" index="-17"/> 
            
        <invoker type="barcode" icon="images/toolbars/barcode.png" caption="Barcode" 
            action="init" target="popup" permission="system" windowmode="glasspane"/>
    </invokers>
    
    <code>
    <![CDATA[    
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.rcp.framework.ClientContext;
        
        class BarcodeSearchController 
        { 
            @Binding
            def binding;
            
            @FormTitle
            def formTitle = "Barcode Search"; 
        
            def prefix;
            String barcode;
            
            void init() { 
                barcode = null; 
            }
            
            def search() {                 
                if (barcode == null || barcode.length() <= 5) return null; 
                
                def prefixid = barcode.substring(0,5); 
                def barcodeid = barcode.substring(6);
                if (prefix != null) prefixid = prefix;
                
                try { 
                    def invoker = InvokerUtil.lookup('global:barcode:'+ prefixid)[0]; 
                    def task = new OpenerTask(binding, invoker, barcodeid);
                    ClientContext.currentContext.taskManager.addTask(task);
                    return '_close'; 
                } catch(e) { 
                    e.printStackTrace();
                    MsgBox.err('No appropriate handler found for this particular barcode. [global:barcode:'+prefixid+']-> '+ barcodeid);
                    return null; 
                } 
            } 
            
            def cancel() {
                return '_close';
            } 
        }
        
        class OpenerTask extends Task 
        {
            def binding;
            def invoker;
            def barcodeid;
            
            OpenerTask(def binding, def invoker, def barcodeid) {
                this.binding = binding;
                this.invoker = invoker;
                this.barcodeid = barcodeid;
            } 
        
            boolean accept() { return true; } 
            
            void execute() { 
                def runnable = [
                    run: {
                        InvokerUtil.invoke(invoker, [barcodeid: barcodeid]); 
                    } 
                ] as Runnable;
                
                java.awt.EventQueue.invokeLater(runnable); 
            } 
        } 
    ]]>
    </code>
    
    <pages>
        <page template="system.tools.ui.BarcodeSearchPage"/> 
    </pages>
    
</workunit>
