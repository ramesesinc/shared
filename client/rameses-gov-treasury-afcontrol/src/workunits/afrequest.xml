<workunit>
    <invokers>
        <invoker folderid="/explorer/txn/treasury/af" action="create" caption="AF Requisition"/> 
        <invoker type="afrequest:create" action="create" caption="AF Requisition" target="window"/>
        <invoker type="afrequest:open" action="open" caption="AF Requisition" target="window"/>        

        <invoker type="afrequest:type" caption="For Purchase" txntype="PURCHASE"/>
        <invoker type="afrequest:type" caption="For Use" txntype="USE"/>
        <invoker type="afrequest:type" caption="For Sale" txntype="SALE"/>
        
        <invoker type="navActions" action="addReqItem" caption="Add Item" visibleWhen="#{state == 'create' }"/>
        <invoker type="navActions" action="addReceipt" caption="Add Receipt" visibleWhen="#{state == 'iraf' }"/>
    </invokers>
    
    <code>
        <![CDATA[
        
            import com.rameses.rcp.annotations.*
            import com.rameses.rcp.common.*
            import com.rameses.osiris2.client.*
            import com.rameses.osiris2.common.*

            class AFRequestController extends PageFlowController {

                @Service("AFRequisitionService")
                def afrequestSvc;
                
                def request = [items:[]];
                def requestTypes;

                def selectedItem;
                def receipt;
                boolean showall = true;
                def mode = "create";
                
                
                @FormId
                public String getDocId() {
                    return ( mode == "create" )? "new-afrequest" : "afrequest"+request.objid;
                }
                
                @FormTitle
                public String getDocTitle() {
                    return ( mode == "create" )? "New Request" : request.objid;
                }
                
                def create() {
                    requestTypes = InvokerUtil.lookupOpeners("afrequest:type").collect{ [name: it.properties.txntype, caption:it.caption] };
                    return super.start();
                }

                def entity;
                def open() {
                    request = afrequestSvc.open(entity);
                    receipt = request.remove("receipt");
                    if(!receipt) {
                        mode = "for-receipt";
                    }    
                    else  {
                        if(receipt.state == "OPEN") {
                            mode = "view-receipt";
                        }
                        else {
                            mode = "view-posted"
                        }
                    }    
                    return super.start();
                }

                void saveRequest() {
                    if(!request.items)
                        throw new Exception("Please add at least one item");
                    request = afrequestSvc.create(request);
                    reqItemModel.reload();
               }
                
                def reqItemModel = [
                    fetchList: {o->
                        request.items;
                    }
                ] as BasicListModel;

                def addReqItem() {
                    return InvokerUtil.lookupOpener( 
                        "afrequest:additem", [  
                            request: request,
                            saveHandler: { 
                                reqItemModel.reload();
                            }
                         ]
                     );
                }
                
                void createReceipt() {
                    receipt = [items:[]];
                }
               
                def issuedItemModel = [
                    fetchList: { o->
                        if(showall) return receipt.items;
                        if(!selectedItem) return [];
                        return receipt.items.findAll { it.af == selectedItem.af };
                    }
                ] as BasicListModel;
                
                def addReceipt() {
                    def openerName = ( request.txntype != "PURCHASE" ) ? "afreceipt:issueitem"  : "afreceipt:additem" ;
                    return InvokerUtil.lookupOpener( 
                        openerName, [  
                            request:request, 
                            receipt: receipt,
                            saveHandler: {
                                reqItemModel.reload();
                                issuedItemModel.reload();
                            }
                     ]);
                }
                
                void saveReceipt() {
                    def r = [request:request, receipt: receipt ];
                    r = afrequestSvc.saveReceipt( r );    
                    request = r.request;
                    receipt = r.receipt;
                }
                
                
            }
        ]]>
    </code>
    
    <pageflow>
        
        <start>
            <transition to="initial" cond="#{mode=='create'}"/>
            <transition to="for-receipt" cond="#{mode=='for-receipt'}"/>
            <transition to="view-receipt" cond="#{mode=='view-receipt'}"/>
            <transition to="posted" cond="#{mode=='view-posted'}"/>
        </start>
        
        <page name="initial" title="AF Requisition Initial">
            <transition to="end" caption="Close"/>
            <transition to="create" caption="Next"/>
        </page>
        
        <page name="create" title="AF Requisition Details">
            <transition to="end" caption="Close"/>
            <transition to="for-receipt" caption="Submit" action="saveRequest" confirm="You are about to submit this request. Continue?"/>
        </page>
        
        <page name="for-receipt" title="AF For Receipt">
            <transition to="end" caption="Close"/>
            <transition to="iraf" caption="Receive" action="createReceipt"/>
        </page>
        
        <page name="iraf" title="AF Receipt">
            <transition to="end" caption="Close" />
            <transition to="posted" caption="Submit" action="saveReceipt" confirm="You are about to update the AF inventory. Proceed?"/>
        </page>
        
        <page name="posted" title="AF Requsition (Closed)">
            <transition to="end" caption="Close"/>
        </page>
        
        <end/>
    </pageflow>
    <pages>
        <page name="initial" template="com.rameses.gov.treasury.af.AFRequestInitialPage"/>
        <page name="create" template="com.rameses.gov.treasury.af.AFRequestPage"/>
        <page name="for-receipt" template="com.rameses.gov.treasury.af.AFRequestPage"/>
        <page name="iraf" template="com.rameses.gov.treasury.af.IRAFPage"/>
        <page name="posted" template="com.rameses.gov.treasury.af.IRAFPage"/>
    </pages>
</workunit>