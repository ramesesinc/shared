<workunit>
    
   <invokers>
         <invoker type="collectiontype:open" caption="Collection Type" action="open"/>
         <invoker type="collectiontype:create" caption="Collection Type" action="create"/>
   </invokers>
   
   <code>
       <![CDATA[
        import com.rameses.osiris2.common.*;
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        
        class CollectionTypeController extends CRUDController {
        
            @Service("CollectionTypeService")
            def service;
            
            String entityName = "collectiontype";
            String prefixId = "COLLTYPE";
            def selectedForm;
            def selectedHandler;
            def handlers;
            
            @PropertyChangeListener
            def listener = [
                "selectedForm" : { o->
                    entity.formno = o.formno;
                    buildHandlers();
                },
                "selectedHandler" : { o->
                    entity.handler = o.name;
                }
            ]
            
            void afterOpen( def o ) {
                selectedForm = formTypes.find{ it.formno == o.formno };
                buildHandlers();
                selectedHandler = handlers.find{ it.name == entity.handler };
            }
            
            def getFormTypes() {
                return service.getFormTypes();
            }
            
            void buildHandlers() {
                handlers = InvokerUtil.lookupOpeners( "collectiontype:handler" ).collect {
                    [ 
                        name:it.properties.name,  
                        caption: it.caption,
                        formno: it.properties.formno,
                        formtype:it.properties.formtype
                    ]
                }.findAll {
                    if( it.formno ) {
                        return (it.formno == selectedForm.formno);
                    }
                    else if(it.formtype) {
                        return (it.formtype == selectedForm.formtype);
                    }
                    return false;
                };
            }
            
        }      
       ]]>
   </code>
   
   <pages>
       <page template="com.rameses.enterprise.treasury.collection.CollectionTypePage" />
   </pages>
   
</workunit>