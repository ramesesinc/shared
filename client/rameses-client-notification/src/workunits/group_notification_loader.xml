<workunit>
    <invokers>
        <invoker type="loader:after" caption="group-notification-loader" action="init" target="process" index="0"/>
    </invokers>
    
    <code>
    <![CDATA[ 
    import com.rameses.rcp.common.*;
    import com.rameses.rcp.annotations.*;
    import com.rameses.osiris2.client.*;
    import com.rameses.osiris2.common.*;
    import com.rameses.rcp.framework.ClientContext;
    import com.rameses.client.notification.*;
    
    class GroupNotificationLoaderController 
    {   
        def groups = [];
        
        def init() { 
            def env = ClientContext.currentContext.appEnv;
            if (!env['ws.host']) return;
            
            Inv.lookup('notification-group').each{
                def groupname = it.properties.group;
                if (groupname) groups.add(groupname.toUpperCase()); 
            } 
            
            WebsocketClient.open([ 
                protocol        : 'group', 
                host            : env['ws.host'], 
                maxConnection   : env['ws.maxConnection'],
                reconnectDelay  : env['ws.reconnectDelay'],
                maxIdleTime     : env['ws.maxIdleTime'], 
                
                onstart     : { 
                    try { 
                        def svc = new GroupNotificationService();
                        svc.getNotified([groups: groups]); 
                    } catch(Throwable t) { 
                        t.printStackTrace(); 
                    } 
                }, 
                
                onmessage   : {o-> 
                    if (!o?.groupid) return;
                    if (groups.contains(o.groupid.toUpperCase())) { 
                        Notification.publish(o); 
                    } 
                } 
            ]); 
            return '_close'; 
        }         
    } 
    ]]> 
    </code>
</workunit>
