import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import com.rameses.common.*
import com.rameses.services.extended.*;

class RuleDeveloperService  {

	@ActiveDB("rule")
	def em;
	
	@Service("DateService")
	def dateSvc;

	@Service("TemplateService")
	def template;

	@Env
	def env;

	@ProxyMethod
	public def saveFact( def o ) {
		if(!o.sortorder) o.sortorder = 0;
		em.save(o, "fact");
		o._deleted_fields?.each { 
			em.delete(it, "fact_field");
		}
		int i= 1;
		o.fields.each {
			it.sortorder = (i++);
			it.parentid = o.objid;
			em.save( it, "fact_field" );
		}
	}
	
	@ProxyMethod
	public def findFact( def o ) {
		def f = em.read( o, "fact" );
		f.fields = em.getFactFields(o);
		return f;
	}


	@ProxyMethod
	public def saveActionDef( def o ) {
		em.save(o, "actiondef");
		o._deleted_params?.each { 
			em.delete(it, "actiondef_param");
		}
		int i = 1;
		o.params.each {
			it.sortorder = (i++);
			it.parentid = o.objid;
			em.save( it, "actiondef_param")
		}
	}

	@ProxyMethod
	public def findActionDef(o) {
		def a = em.read( o, "actiondef" );
		a.params = em.getActionDefParams(o);
		return a;
	}

	@ProxyMethod
	public void removeFact(o) {
		em.removeFactFields(o);
		em.removeFact(o);
	}

	@ProxyMethod
	public void removeActionDef(o) {
		em.removeActionDefParams(o);
		em.removeActionDef(o);
	}


}
